var W=Object.create;var v=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var U=n=>v(n,"__esModule",{value:!0}),s=(n,r)=>v(n,"name",{value:r,configurable:!0});var P=(n,r)=>{for(var e in r)v(n,e,{get:r[e],enumerable:!0})},L=(n,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of j(r))!q.call(n,i)&&(e||i!=="default")&&v(n,i,{get:()=>r[i],enumerable:!(t=_(r,i))||t.enumerable});return n},p=(n,r)=>L(U(v(n!=null?W(D(n)):{},"default",!r&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),F=(n=>(r,e)=>n&&n.get(r)||(e=L(U({}),r,1),n&&n.set(r,e),e))(typeof WeakMap!="undefined"?new WeakMap:0);var B={};P(B,{Music:()=>w,TTScraper:()=>d,TikTokResult:()=>b,User:()=>I,Video:()=>g,fetchAllVideosFromUser:()=>G,fetchMusic:()=>z,fetchUser:()=>Y,fetchVideo:()=>J,fetchVideoNoWaterMark:()=>H,hashtag:()=>K});var S=p(require("cheerio")),x=p(require("miniget")),T=p(require("node-fetch")),m=require("fs"),E=p(require("puppeteer")),$=p(require("http")),N=p(require("https")),V=require("process");var I=class{constructor(r,e,t,i,o,u,c,h,l,f,M,k,y,A,C){this.id=r,this.uniqueId=e,this.nickname=t,this.avatar=i,this.signature=o,this.createdAt=u,this.verified=c,this.secretUID=h,this.bioLink=l,this.privateAccount=f,this.isUnderAge18=M,this.followers=k,this.following=y,this.hearts=A,this.videos=C}};s(I,"User");var b=class{constructor(r,e,t,i,o,u,c,h,l,f){this.author=r,this.video=e,this.audio=t,this.shareCount=i,this.likesCount=o,this.commentCount=u,this.playCount=c,this.createdAt=h,this.tiktokLink=l,this.thumbnail=f}};s(b,"TikTokResult");var g=class{constructor(r,e,t,i,o,u,c,h,l,f,M,k,y,A,C,R,O){this.id=r,this.description=e,this.createdAt=t,this.height=i,this.width=o,this.duration=u,this.resolution=c,this.shareCount=h,this.likesCount=l,this.commentCount=f,this.playCount=M,this.downloadURL=k,this.cover=y,this.dynamicCover=A,this.playURL=C,this.format=R,this.author=O}};s(g,"Video");var w=class{constructor(r,e,t,i,o,u,c,h,l){this.id=r,this.title=e,this.playURL=t,this.coverLarge=i,this.coverThumb=o,this.author=u,this.duration=c,this.original=h,this.album=l}};s(w,"Music");var d=class{constructor(r){this._cookies="";this._cookies=r}async requestWebsite(r,e){let t=new $.default.Agent({keepAlive:!0,maxSockets:20}),i=new N.default.Agent({keepAlive:!0,maxSockets:20}),o={agent:l=>l.protocol=="http:"?t:i,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Connection:"keep-alive",Cookie:`${this._cookies}`}},c=await(await(0,T.default)(`${r}`,e||o)).text();return S.load(c,{xmlMode:!0})}extractJSONObject(r){let e=r.split('<script id="SIGI_STATE" type="application/json">')[1].indexOf("<\/script>");return r.split('<script id="SIGI_STATE" type="application/json">')[1].slice(0,e)}checkJSONExisting(r){try{return!!JSON.parse(r)}catch{}}async requestWithPuppeteer(r){let e=await E.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}),i=await(await e.newPage()).goto(r);if(i==null)throw new Error("Could not load the desired Page!");let o=await i.text();return await e.close(),this.extractJSONObject(o)}handleHTMLContent(r){let e=r,t=e.split("window['SIGI_STATE']=")[1].indexOf(";window['SIGI_RETRY']=");return JSON.parse(e.split("window['SIGI_STATE']=")[1].slice(0,t))}async TryFetch(r){let e=await this.requestWebsite(r);if(this.checkJSONExisting(e("#SIGI_STATE").text()))return JSON.parse(e("#SIGI_STATE").text());{let t=await this.requestWithPuppeteer(r);return JSON.parse(t)}}async video(r,e){if(!r)throw new Error("A video URL must be provided");let t=await this.TryFetch(r),i=t.ItemList.video.list[0];return new g(t.ItemModule[i].video.id,t.ItemModule[i].desc,new Date(Number(t.ItemModule[i].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[i].video.height),Number(t.ItemModule[i].video.width),Number(t.ItemModule[i].video.duration),t.ItemModule[i].video.ratio,t.ItemModule[i].stats.shareCount,t.ItemModule[i].stats.diggCount,t.ItemModule[i].stats.commentCount,t.ItemModule[i].stats.playCount,e?await this.noWaterMark(t.ItemModule[i].video.id):t.ItemModule[i].video.downloadAddr.trim(),t.ItemModule[i].video.cover,t.ItemModule[i].video.dynamicCover,e?await this.noWaterMark(t.ItemModule[i].video.id):t.ItemModule[i].video.playAddr.trim(),t.ItemModule[i].video.format,t.ItemModule[i].nickname)}async user(r){if(!r)throw new Error("Please enter a username");let e=await this.TryFetch(`https://www.tiktok.com/@${r}`),t=e.UserModule.users[r];return new I(t.id,t.uniqueId,t.nickname,t.avatarLarger,t.signature.trim(),new Date(t.createTime*1e3).toLocaleDateString(),t.verified,t.secUid,t?.bioLink?.link,t.privateAccount,t.isUnderAge18,e.UserModule.stats[r].followerCount,e.UserModule.stats[r].followingCount,e.UserModule.stats[r].heart,e.UserModule.stats[r].videoCount)}async getAllVideosFromUser(r){if(!r)throw new Error("You must provide a username!");let e=await this.TryFetch(`https://www.tiktok.com/@${r}`),t=[],{ItemList:i}=e;return i["user-post"].list.forEach(o=>{t.push(new g(e.ItemModule[o].video.id,e.ItemModule[o].desc,new Date(Number(e.ItemModule[o].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[o].video.height),Number(e.ItemModule[o].video.width),Number(e.ItemModule[o].video.duration),e.ItemModule[o].video.ratio,e.ItemModule[o].stats.shareCount,e.ItemModule[o].stats.diggCount,e.ItemModule[o].stats.commentCount,e.ItemModule[o].stats.playCount,e.ItemModule[o].video.downloadAddr.trim(),e.ItemModule[o].video.cover,e.ItemModule[o].video.dynamicCover,e.ItemModule[o].video.playAddr.trim(),e.ItemModule[o].video.format,e.ItemModule[o].author))}),t}async getMusic(r){if(!r)throw new Error("You must provide a link!");let e=await this.TryFetch(r),t=e.ItemList.video.list[0];return new w(e.ItemModule[t].music.id,e.ItemModule[t].music.title,e.ItemModule[t].music.playUrl,e.ItemModule[t].music.coverLarge,e.ItemModule[t].music.coverThumb,e.ItemModule[t].music.authorName,Number(e.ItemModule[t].music.duration),e.ItemModule[t].music.original,e.ItemModule[t].music.album)}async downloadAllVideosFromUser(r,e){if(!r)throw new Error("Please enter a username!");let t=await this.getAllVideosFromUser(r);if(!t)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!e.path){if(e.path=`${__dirname}/../${r}`,(0,m.existsSync)(e.path)){console.log("A folder with this username exists, that is unusual!");try{(0,m.unlinkSync)(e.path)}catch(i){console.log(`[ERROR] Could not remove ${e.path}
 Error Message: ${i.message}`),(0,V.exit)(1)}}(0,m.existsSync)(e.path)||(0,m.mkdirSync)(e.path)}if(!e.watermark){for(let[i,o]of t.entries()){console.log(`Downloading Video: ${o.description?o.description:o.id}, [${i+1}/${t.length}]`);let u=await this.noWaterMark(o.id);if(!u){console.log(`Could not fetch ${o.description?o.description:o.id} with no watermark`);continue}(0,x.default)(u).pipe((0,m.createWriteStream)(`${e.path}/${o.id}_${o.resolution}.${o.format}`))}return}for(let[i,o]of t.entries())console.log(`Downloading Video: ${o.description?o.description:o.id}, [${i+1}/${t.length}]`),(0,x.default)(o.downloadURL).pipe((0,m.createWriteStream)(`${e.path}/${o.id}_${o.resolution}.${o.format}`))}async noWaterMark(r){let e="";r.startsWith("https")?e=(await this.video(r)).id:e=r;let i=await(await(0,T.default)("https://api2.musical.ly/aweme/v1/aweme/detail/?aweme_id="+e)).json();if(!i)throw new Error("There was an Error retrieveing this video without watermark!");let o=i.aweme_detail.video.download_addr.uri;if(!o)throw new Error("There was an Error retrieveing this video without watermark!");return`https://api-h2.tiktokv.com/aweme/v1/play/?video_id=${o}`}async hashTag(r){if(!r)throw new Error("You must provide a tag name to complete the search!");let e=await this.TryFetch(`https://www.tiktok.com/tag/${r}`),{ItemList:t}=e,i=[];for(let o of t.challenge.list)i.push(new g(e.ItemModule[o].video.id,e.ItemModule[o].desc,new Date(Number(e.ItemModule[o].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[o].video.height),Number(e.ItemModule[o].video.width),Number(e.ItemModule[o].video.duration),e.ItemModule[o].video.ratio,e.ItemModule[o].stats.shareCount,e.ItemModule[o].stats.diggCount,e.ItemModule[o].stats.commentCount,e.ItemModule[o].stats.playCount,e.ItemModule[o].video.downloadAddr.trim(),e.ItemModule[o].video.cover,e.ItemModule[o].video.dynamicCover,e.ItemModule[o].video.playAddr.trim(),e.ItemModule[o].video.format,e.ItemModule[o].author));return i}};s(d,"TTScraper");async function J(n,r){if(!n)throw new Error("You must provide a Tiktok video url!");return await new d().video(n,r)}s(J,"fetchVideo");async function Y(n){if(!n)throw new Error("You must provide a username!");return await new d().user(n)}s(Y,"fetchUser");async function G(n){if(!n)throw new Error("You must provide a username!");return await new d().getAllVideosFromUser(n)}s(G,"fetchAllVideosFromUser");async function z(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new d().getMusic(n)}s(z,"fetchMusic");async function H(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new d().noWaterMark(n)}s(H,"fetchVideoNoWaterMark");async function K(n){if(!n)throw new Error("You must provide a tiktok hashtag");return await new d().hashTag(n)}s(K,"hashtag");module.exports=F(B);0&&(module.exports={Music,TTScraper,TikTokResult,User,Video,fetchAllVideosFromUser,fetchMusic,fetchUser,fetchVideo,fetchVideoNoWaterMark,hashtag});
