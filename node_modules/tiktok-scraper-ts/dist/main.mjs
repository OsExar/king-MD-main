var $=Object.defineProperty;var s=(n,o)=>$(n,"name",{value:o,configurable:!0});import{fileURLToPath as N}from"url";import R from"path";var V=s(()=>N(import.meta.url),"getFilename"),O=s(()=>R.dirname(V()),"getDirname"),a=O();import*as U from"cheerio";import A from"miniget";import C from"node-fetch";import{createWriteStream as x,existsSync as T,mkdirSync as _,unlinkSync as W}from"node:fs";import*as L from"puppeteer";import j from"node:http";import D from"node:https";import{exit as P}from"node:process";var I=class{constructor(o,e,t,i,r,d,c,h,l,p,f,v,b,M,k){this.id=o,this.uniqueId=e,this.nickname=t,this.avatar=i,this.signature=r,this.createdAt=d,this.verified=c,this.secretUID=h,this.bioLink=l,this.privateAccount=p,this.isUnderAge18=f,this.followers=v,this.following=b,this.hearts=M,this.videos=k}};s(I,"User");var y=class{constructor(o,e,t,i,r,d,c,h,l,p){this.author=o,this.video=e,this.audio=t,this.shareCount=i,this.likesCount=r,this.commentCount=d,this.playCount=c,this.createdAt=h,this.tiktokLink=l,this.thumbnail=p}};s(y,"TikTokResult");var g=class{constructor(o,e,t,i,r,d,c,h,l,p,f,v,b,M,k,S,E){this.id=o,this.description=e,this.createdAt=t,this.height=i,this.width=r,this.duration=d,this.resolution=c,this.shareCount=h,this.likesCount=l,this.commentCount=p,this.playCount=f,this.downloadURL=v,this.cover=b,this.dynamicCover=M,this.playURL=k,this.format=S,this.author=E}};s(g,"Video");var w=class{constructor(o,e,t,i,r,d,c,h,l){this.id=o,this.title=e,this.playURL=t,this.coverLarge=i,this.coverThumb=r,this.author=d,this.duration=c,this.original=h,this.album=l}};s(w,"Music");var m=class{constructor(o){this._cookies="";this._cookies=o}async requestWebsite(o,e){let t=new j.Agent({keepAlive:!0,maxSockets:20}),i=new D.Agent({keepAlive:!0,maxSockets:20}),r={agent:l=>l.protocol=="http:"?t:i,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Connection:"keep-alive",Cookie:`${this._cookies}`}},c=await(await C(`${o}`,e||r)).text();return U.load(c,{xmlMode:!0})}extractJSONObject(o){let e=o.split('<script id="SIGI_STATE" type="application/json">')[1].indexOf("<\/script>");return o.split('<script id="SIGI_STATE" type="application/json">')[1].slice(0,e)}checkJSONExisting(o){try{return!!JSON.parse(o)}catch{}}async requestWithPuppeteer(o){let e=await L.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}),i=await(await e.newPage()).goto(o);if(i==null)throw new Error("Could not load the desired Page!");let r=await i.text();return await e.close(),this.extractJSONObject(r)}handleHTMLContent(o){let e=o,t=e.split("window['SIGI_STATE']=")[1].indexOf(";window['SIGI_RETRY']=");return JSON.parse(e.split("window['SIGI_STATE']=")[1].slice(0,t))}async TryFetch(o){let e=await this.requestWebsite(o);if(this.checkJSONExisting(e("#SIGI_STATE").text()))return JSON.parse(e("#SIGI_STATE").text());{let t=await this.requestWithPuppeteer(o);return JSON.parse(t)}}async video(o,e){if(!o)throw new Error("A video URL must be provided");let t=await this.TryFetch(o),i=t.ItemList.video.list[0];return new g(t.ItemModule[i].video.id,t.ItemModule[i].desc,new Date(Number(t.ItemModule[i].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[i].video.height),Number(t.ItemModule[i].video.width),Number(t.ItemModule[i].video.duration),t.ItemModule[i].video.ratio,t.ItemModule[i].stats.shareCount,t.ItemModule[i].stats.diggCount,t.ItemModule[i].stats.commentCount,t.ItemModule[i].stats.playCount,e?await this.noWaterMark(t.ItemModule[i].video.id):t.ItemModule[i].video.downloadAddr.trim(),t.ItemModule[i].video.cover,t.ItemModule[i].video.dynamicCover,e?await this.noWaterMark(t.ItemModule[i].video.id):t.ItemModule[i].video.playAddr.trim(),t.ItemModule[i].video.format,t.ItemModule[i].nickname)}async user(o){if(!o)throw new Error("Please enter a username");let e=await this.TryFetch(`https://www.tiktok.com/@${o}`),t=e.UserModule.users[o];return new I(t.id,t.uniqueId,t.nickname,t.avatarLarger,t.signature.trim(),new Date(t.createTime*1e3).toLocaleDateString(),t.verified,t.secUid,t?.bioLink?.link,t.privateAccount,t.isUnderAge18,e.UserModule.stats[o].followerCount,e.UserModule.stats[o].followingCount,e.UserModule.stats[o].heart,e.UserModule.stats[o].videoCount)}async getAllVideosFromUser(o){if(!o)throw new Error("You must provide a username!");let e=await this.TryFetch(`https://www.tiktok.com/@${o}`),t=[],{ItemList:i}=e;return i["user-post"].list.forEach(r=>{t.push(new g(e.ItemModule[r].video.id,e.ItemModule[r].desc,new Date(Number(e.ItemModule[r].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[r].video.height),Number(e.ItemModule[r].video.width),Number(e.ItemModule[r].video.duration),e.ItemModule[r].video.ratio,e.ItemModule[r].stats.shareCount,e.ItemModule[r].stats.diggCount,e.ItemModule[r].stats.commentCount,e.ItemModule[r].stats.playCount,e.ItemModule[r].video.downloadAddr.trim(),e.ItemModule[r].video.cover,e.ItemModule[r].video.dynamicCover,e.ItemModule[r].video.playAddr.trim(),e.ItemModule[r].video.format,e.ItemModule[r].author))}),t}async getMusic(o){if(!o)throw new Error("You must provide a link!");let e=await this.TryFetch(o),t=e.ItemList.video.list[0];return new w(e.ItemModule[t].music.id,e.ItemModule[t].music.title,e.ItemModule[t].music.playUrl,e.ItemModule[t].music.coverLarge,e.ItemModule[t].music.coverThumb,e.ItemModule[t].music.authorName,Number(e.ItemModule[t].music.duration),e.ItemModule[t].music.original,e.ItemModule[t].music.album)}async downloadAllVideosFromUser(o,e){if(!o)throw new Error("Please enter a username!");let t=await this.getAllVideosFromUser(o);if(!t)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!e.path){if(e.path=`${a}/../${o}`,T(e.path)){console.log("A folder with this username exists, that is unusual!");try{W(e.path)}catch(i){console.log(`[ERROR] Could not remove ${e.path}
 Error Message: ${i.message}`),P(1)}}T(e.path)||_(e.path)}if(!e.watermark){for(let[i,r]of t.entries()){console.log(`Downloading Video: ${r.description?r.description:r.id}, [${i+1}/${t.length}]`);let d=await this.noWaterMark(r.id);if(!d){console.log(`Could not fetch ${r.description?r.description:r.id} with no watermark`);continue}A(d).pipe(x(`${e.path}/${r.id}_${r.resolution}.${r.format}`))}return}for(let[i,r]of t.entries())console.log(`Downloading Video: ${r.description?r.description:r.id}, [${i+1}/${t.length}]`),A(r.downloadURL).pipe(x(`${e.path}/${r.id}_${r.resolution}.${r.format}`))}async noWaterMark(o){let e="";o.startsWith("https")?e=(await this.video(o)).id:e=o;let i=await(await C("https://api2.musical.ly/aweme/v1/aweme/detail/?aweme_id="+e)).json();if(!i)throw new Error("There was an Error retrieveing this video without watermark!");let r=i.aweme_detail.video.download_addr.uri;if(!r)throw new Error("There was an Error retrieveing this video without watermark!");return`https://api-h2.tiktokv.com/aweme/v1/play/?video_id=${r}`}async hashTag(o){if(!o)throw new Error("You must provide a tag name to complete the search!");let e=await this.TryFetch(`https://www.tiktok.com/tag/${o}`),{ItemList:t}=e,i=[];for(let r of t.challenge.list)i.push(new g(e.ItemModule[r].video.id,e.ItemModule[r].desc,new Date(Number(e.ItemModule[r].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[r].video.height),Number(e.ItemModule[r].video.width),Number(e.ItemModule[r].video.duration),e.ItemModule[r].video.ratio,e.ItemModule[r].stats.shareCount,e.ItemModule[r].stats.diggCount,e.ItemModule[r].stats.commentCount,e.ItemModule[r].stats.playCount,e.ItemModule[r].video.downloadAddr.trim(),e.ItemModule[r].video.cover,e.ItemModule[r].video.dynamicCover,e.ItemModule[r].video.playAddr.trim(),e.ItemModule[r].video.format,e.ItemModule[r].author));return i}};s(m,"TTScraper");async function Ae(n,o){if(!n)throw new Error("You must provide a Tiktok video url!");return await new m().video(n,o)}s(Ae,"fetchVideo");async function Ce(n){if(!n)throw new Error("You must provide a username!");return await new m().user(n)}s(Ce,"fetchUser");async function xe(n){if(!n)throw new Error("You must provide a username!");return await new m().getAllVideosFromUser(n)}s(xe,"fetchAllVideosFromUser");async function Te(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new m().getMusic(n)}s(Te,"fetchMusic");async function Ue(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new m().noWaterMark(n)}s(Ue,"fetchVideoNoWaterMark");async function Le(n){if(!n)throw new Error("You must provide a tiktok hashtag");return await new m().hashTag(n)}s(Le,"hashtag");export{w as Music,m as TTScraper,y as TikTokResult,I as User,g as Video,xe as fetchAllVideosFromUser,Te as fetchMusic,Ce as fetchUser,Ae as fetchVideo,Ue as fetchVideoNoWaterMark,Le as hashtag};
